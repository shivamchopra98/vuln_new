# transform.py
import pandas as pd
from datetime import datetime
import os

def transform_csv(csv_path):
    """
    Reads CSV, adds 'uploaded_date' and 'CVE_id' columns.
    Saves the CSV back to same path.
    """
    print(f"ðŸ”„ Transforming CSV: {csv_path}")
    
    # Read CSV
    df = pd.read_csv(csv_path, dtype=str)  # read all as string

    # Add uploaded_date column
    today_str = datetime.now().strftime("%Y-%m-%d")
    df['uploaded_date'] = today_str

    # Extract CVE codes from 'codes' column
    def extract_cve(codes):
        if pd.isna(codes):
            return None
        cve_list = [code for code in codes.split(';') if code.startswith('CVE')]
        return ';'.join(cve_list) if cve_list else None

    df['CVE_id'] = df['codes'].apply(extract_cve)

    # Save transformed CSV back
    df.to_csv(csv_path, index=False)
    print("âœ… CSV transformed with 'uploaded_date' and 'CVE_id' columns")
