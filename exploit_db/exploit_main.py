# exploit_main.py
from extract import download_raw_csv
from transform import transform_csv
from load import sync_today_with_dynamodb
import os

RAW_CSV_URL = "https://gitlab.com/exploit-database/exploitdb/-/raw/main/files_exploits.csv"
PROJECT_ROOT = r"C:\Users\ShivamChopra\Projects\vuln\exploit_db"
DAILY_DIR = os.path.join(PROJECT_ROOT, "daily_extract")

def main():
    # 1) extract -> download to daily_extract/YYYY-MM-DD.csv
    try:
        csv_path = download_raw_csv(RAW_CSV_URL, DAILY_DIR)
    except Exception as e:
        print(f"❌ Download failed: {e}")
        return

    # 2) transform -> add uploaded_date
    try:
        transform_csv(csv_path)
    except Exception as e:
        print(f"❌ Transformation failed: {e}")
        return

    # 3) load -> compare with data in dynamo db with (exploit_extract.csv), build delta, sync to DynamoDB
    try:
        result = sync_today_with_dynamodb(csv_path)
        print("✅ Sync result:", result)
    except Exception as e:
        print(f"❌ Load/sync failed: {e}")
        return

if __name__ == "__main__":
    main()
